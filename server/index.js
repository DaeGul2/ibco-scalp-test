require("dotenv").config();
const express = require("express");
const cors = require("cors");
const multer = require("multer");
const fs = require("fs");
const path = require("path");
const OpenAI = require("openai"); // âœ… OpenAI ë¼ì´ë¸ŒëŸ¬ë¦¬ í˜¸ì¶œ ìˆ˜ì •

const app = express();
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

app.use(cors({ origin: process.env.CLIENT_URL }));
app.use(express.json());

// âœ… ì—…ë¡œë“œ í´ë” ìžë™ ìƒì„±
const uploadDir = path.join(__dirname, process.env.UPLOADS_DIR || "uploads");
if (!fs.existsSync(uploadDir)) {
  fs.mkdirSync(uploadDir, { recursive: true });
}

// âœ… Multer ì„¤ì • (íŒŒì¼ ì—…ë¡œë“œ ì €ìž¥)
const storage = multer.diskStorage({
  destination: (req, file, cb) => cb(null, uploadDir),
  filename: (req, file, cb) => cb(null, Date.now() + "-" + file.originalname.replace(/\s/g, "_")),
});
const upload = multer({ storage });

const PUBLIC_SERVER_URL = process.env.PUBLIC_SERVER_URL || "http://localhost:5000";
app.use((req, res, next) => {
  res.setHeader("ngrok-skip-browser-warning", "true");
  next();
});


app.post("/upload", upload.single("file"), async (req, res) => {
  const imageUrl = `${PUBLIC_SERVER_URL}/${process.env.UPLOADS_DIR}/${req.file.filename}`;
  console.log("ðŸ” ì—…ë¡œë“œëœ ì´ë¯¸ì§€ URL:", imageUrl); // âœ… ë””ë²„ê¹…ìš© ë¡œê·¸
  try {
    const response = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [
        {
          role: "system", content: `
         ë‘í”¼ìƒíƒœë¥¼ ë¶„ì„í•˜ë˜ ì•„ëž˜ì˜ ë‚´ìš©ì„ ì½ê³  ì‘ë‹µí•´ì£¼ì„¸ìš”. ì‘ë‹µì‹œì—ëŠ” ë°˜ë“œì‹œ ì ì ˆí•œ jsoní˜•íƒœë¥¼ ë”°ë¼ ì‘ë‹µí•´ì•¼í•©ë‹ˆë‹¤.
         ë‹¹ì‹ ì˜ ë‘í”¼ ì§„ë‹¨ì´ ì •ë§ ëˆ„ê°€ë´ë„ ì •ìƒì ì¸ ë‘í”¼ë¼ë©´, ì •ìƒì´ë¼ê³  ì†”ì§í•˜ê²Œ íŒë‹¨í•˜ë©´ ë©ë‹ˆë‹¤.
         
         ì§„ë‹¨ì´ ë¶ˆê°€í•˜ë”ë¼ë„ ë°˜ë“œì‹œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¥¼ ë³´ë‚´ì§€ë§ê³  ë°˜ë“œì‹œ ì•„ëž˜ì˜ jsoní˜•íƒœì—ë”°ë¼ ë³´ë‚´ì£¼ì„¸ìš”.
          1. ì‚¬ì§„ì„ ë³´ê³  ë‘í”¼ì‚¬ì§„ì— ëŒ€í•´ í•œêµ­ì–´ë¡œ ì§„ë‹¨ì„ ë‚´ë ¤ì£¼ì„¸ìš”. ë‹¨, ì‚¬ì§„ì´ ë„ˆë¬´ ì–´ë‘¡ê±°ë‚˜ í˜¹ì€ ë‘í”¼ê°€ ë„ˆë¬´ ë©€ë¦¬ ì°í˜€ ìžˆì–´ì„œ ì§„ë‹¨ì´ ì–´ë µë‹¤ë©´, 'ì§„ë‹¨ë¶ˆê°€'ë¥¼ íŒë‹¨í•˜ì„¸ìš”.
          2. ì§„ë‹¨ ê°€ëŠ¥í•œ ê²½ìš°, bounding boxë¥¼ ìœ„í•´ ê° ë°•ìŠ¤ë³„ x, y, width, height ê°’ì„ {x,y,width,height} objectë¡œ ë°°ì—´ ì•ˆì— ë‹´ì•„ ë³´ë‚´ì£¼ì„¸ìš”. ì—¬ëŸ¬ê°œ ë°œê²¬ë˜ë©´ ì—¬ëŸ¬ê°œ ë³´ë‚´ë„ ë©ë‹ˆë‹¤.
          ì§„ë‹¨ ê°€ëŠ¥í•œëŒ€ë¡œ ì „ë¶€ ë³´ë‚´ì£¼ì„¸ìš”.
          3. ì§„ë‹¨ ê·¼ê±° ì„¤ëª…ë„ í•¨ê»˜ ì œê³µí•˜ì„¸ìš”.
          4. ì¶”ì²œí•˜ëŠ” ì œí’ˆë“¤ì„ ë°°ì—´ì— ë‹´ì•„ ë³´ë‚´ì£¼ì„¸ìš”. ë‹¨ ì œí’ˆ ì´ë¦„ì€ ë‹¤ìŒ ë°°ì—´ ì¤‘ í•˜ë‚˜ì— í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
            [í‚¤ì¦ˆìƒ´í‘¸, í‹´ì—ì´ì €ìƒ´í‘¸, íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸, ë°”ë””ë¡œì…˜, ë°”ë””ì›Œì‹œ, íŽ˜ì´ì…œí¼, ì„ í¬ë¦¼]
            ì•„ëž˜ëŠ” ê° ìƒí’ˆë³„ íŠ¹ì§• ë°  ì„±ë¶„ìž…ë‹ˆë‹¤.
- í‚¤ì¦ˆìƒ´í‘¸ : íŠ¹í—ˆë°›ì€ ì¶”ì¶œê³µë²•*ìœ¼ë¡œ ì¶”ì¶œí•œ 'ì¼ë¼ì´íŠ¸ ì¶”ì¶œë¬¼'ì€ í•­ì—¼Â·í•­ê·  íš¨ê³¼ê°€ ì—°ì•½í•˜ê³  ë¯¼ê°í•œ ë‘í”¼ë¥¼ ê±´ê°•í•˜ê²Œ ë³´í˜¸í•´ ì£¼ë©°, ì²­ê²°í•œ ë‘í”¼ë¥¼ ìœ ì§€, ë±ìŠ¤íŒí…Œë†€ ì™¸ë¶€ ìœ í•´í™˜ê²½ìœ¼ë¡œë¶€í„° ì†ìƒëœ ë‘í”¼ì™€ ëª¨ë°œì„ íšŒë³µ, ë‘í”¼ê±´ì¡° ì˜ˆë°©ì— ë„ì›€, ì„¸ë¼ë§ˆì´ë“œì—”í”¼ ëª¨ë°œì— ìœ¤ê¸°ì™€ ê´‘íƒì„ ë¶€ì—¬í•˜ì—¬ ì†ìƒë˜ì§€ ì•Šë„ë¡ ë³´í˜¸, ì •ìˆ˜ë¦¬ ëƒ„ìƒˆ ì—†ì•°, ëª¨ë°œê±´ì¡°í•¨ ì˜ˆë°©
- í‹´ì—ì´ì €ìƒ´í‘¸: ì‚´ë¦¬ì‹¤ë¦­ì• ì”¨ë“œ íƒˆëª¨ì¦ìƒì™„í™” ê¸°ëŠ¥ì„±ì›ë£Œ ë‘í”¼ ì† ê³¼ë„í•œ í”¼ì§€ì™€ ê°ì§ˆì„ ì œê±°í•´, ë‘í”¼ íŠ¸ëŸ¬ë¸” ë°©ì§€ì— ë„ì›€, ì—˜-ë©˜í†¨ íƒˆëª¨ì¦ìƒì™„í™” ê¸°ëŠ¥ì„±ì›ë£Œ ë‘í”¼ì— ë°œìƒí•˜ëŠ” ì—´ì„ ë¹ ë¥´ê²Œ ë‚®ì²˜ì¤Œ, ì‚´ë¦¬ì‹¤ë¦­ì• ì”¨ë“œ *íƒˆëª¨ì¦ìƒì™„í™” ê¸°ëŠ¥ì„±ì›ë£Œ ë‘í”¼ ì† ê³¼ë„í•œ í”¼ì§€ì™€ ê°ì§ˆì„ ì œê±°í•´, ë‘í”¼ íŠ¸ëŸ¬ë¸” ë°©ì§€ì— ë„ì›€
- íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ : ì–´ë¦°ì´ë¶€í„° ì„±ì¸ê¹Œì§€ ì‚¬ìš© ê°€ëŠ¥í•œ ë…¼-ì‹¤ë¦¬ì½˜ íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸, ë‘í”¼ì˜ ëª¨ê³µì„ ë§‰ì•„ íŠ¸ëŸ¬ë¸”ì„ ìœ ë°œí•˜ëŠ” ì‹¤ë¦¬ì½˜(ì‚¬ì´í´ë¡œí…ŒíŠ¸ë¼ì‹¤ë¡ì‚°, ë””ë©”ì¹˜ì½˜, ì•„ëª¨ë‹¤ì´ë©”í‹°ì½˜ ë“±)ì„ í•¨ìœ í•˜ì§€ ì•Šì•„, ì—°ì•½í•œ ëª¨ë°œê³¼ ë‘í”¼ì— ì•ˆì‹¬í•˜ê³  ì‚¬ìš©ê°€ëŠ¥,í”¼ë§ˆìžì”¨ì—ì„œ ì¶”ì¶œí•œ ì‹ë¬¼ì„± ì˜¤ì¼ê³¼ ì½”ì½”ë„› ìœ ëž˜ ë³´ìŠµ ì„±ë¶„ë“¤ì´ ì¦‰ê°ì ì¸ ë¶€ë“œëŸ¬ì›€ì„ ë¶€ì—¬, ì–´ë¦°ì´ë„ ì‚¬ìš© ê°€ëŠ¥, (ë‘í”¼ì˜ ëª¨ê³µì„ ë§‰ëŠ” ì‹¤ë¦¬ì½˜, í”¼ë¶€ìžê·¹ì„ ìœ ë°œí•˜ëŠ” í•©ì„±ê³„ë©´í™œì„±ì œ,ìœ í•´ì„± ë…¼ëž€ì´ ìžˆëŠ” íŒŒë¼ë²¤ , í™”í•™ì  ë°©ë¶€ì œì¸ íŽ˜ë…¹ì‹œì—íƒ„ì˜¬ , ì•Œë ˆë¥´ê¸° ìœ ë°œê°€ëŠ¥ì„±ì´ ìžˆëŠ” ì¸ê³µìƒ‰ì†Œ ë“±ì´ ì—†ìŒ)
- ë°”ë””ë¡œì…˜ : ë´‡ë¸Œì— ì¢‹ìŒ, í”¼ë¶€ ì˜ˆë¯¼í•œì‚¬ëžŒí•œí…Œ ì¢‹ìŒ, ì•„ì´ê°€ ë‹¿ì•„ë„ ì•ˆì „í•œ ì„±ë¶„, ìžê·¹ì—†ì´ ì´‰ì´‰ , ì¼ë¼ì´íŠ¸ ì¶”ì¶œë¬¼ í•¨ìœ , ì„¸ë¼ë§ˆì´ë“œ ,íŒí…Œë†€, ì•Œëž€í† ì¸, ê¸€ë¦¬ì„¸ë¦°, ížˆì•Œë£¨ë¡ ì‚°ìœ¼ë¡œ 5ì¤‘ ë³´ìŠµ, 5ê°€ì§€ ìžì—° ìœ ëž˜ ì˜¤ì¼ ì‚¬ìš©
- ë°”ë””ì›Œì‹œ, ì„ í¬ë¦¼, íŽ˜ì´ì…œí¼ë„ ë¹„ìŠ·í•œ ë§¥ë½ìž„
          5. ì œí’ˆ ì¶”ì²œ ì´ìœ ë¥¼ ë‘í”¼ ìƒíƒœì— ê¸°ë°˜í•˜ì—¬ ì œê³µí•˜ì„¸ìš”. ë‹¹ì—°ížˆ ì§„ë‹¨ë¶ˆê°€ë©´ ì¶”ì²œì„ ì•ˆ í•´ì•¼í•©ë‹ˆë‹¤.
          6. JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
            - result : 1 or 0 (ì§„ë‹¨ ê°€ëŠ¥í•˜ë©´ 1, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ 0)
            - yoloBoxes : [{ x, y, width, height }]
            - analysis : ë¶„ì„ ê²°ê³¼
            - analysis_reason : ë¶„ì„ ê·¼ê±°
            - recommendation : [{ product_name, reason }]
    7. ì œí’ˆ ì¶”ì²œ ê·¼ê±°ëŠ”, ì œê°€ ë³´ë‚¸ ìš°ë¦¬ ì œí’ˆì˜ ì œí’ˆë³„ ìž¥ì  ë‚´ì—ì„œ ì°¾ì•„ì„œ ë¶€í’€ë ¤ì¤˜ì•¼í•©ë‹ˆë‹¤.        
` },
        {
          role: "user",
          content: [
            { type: "text", text: `ì´ ì‚¬ì§„ì„ ë¶„ì„í•´ì¤˜.` },
            { type: "image_url", image_url: { url: imageUrl } } // âœ… ì˜¬ë°”ë¥¸ ê°ì²´ í˜•íƒœë¡œ ë³€ê²½
          ]
        }
      ],
    });

   
    let aiResponse = response.choices[0].message.content.trim();
    console.log("ðŸ› ï¸ GPT ì‘ë‹µ ì›ë³¸:", aiResponse);

    // ðŸ”¥ JSON ì½”ë“œ ë¸”ë¡(````json ... ````) ì œê±°
    if (aiResponse.startsWith("```json")) {
      aiResponse = aiResponse.replace(/^```json/, "").replace(/```$/, "").trim();
    } else if (aiResponse.startsWith("```")) {
      aiResponse = aiResponse.replace(/^```/, "").replace(/```$/, "").trim();
    }

    console.log("âœ… JSON ë³€í™˜ ì „:", aiResponse);

    // JSON ì‘ë‹µì´ ì•„ë‹ˆë©´ "ì§„ë‹¨ ë¶ˆê°€" ì²˜ë¦¬
    let parsedResponse;
    try {
      parsedResponse = JSON.parse(aiResponse);
    } catch (error) {
      console.error("ðŸš¨ JSON íŒŒì‹± ì˜¤ë¥˜: ì‘ë‹µì´ JSON í˜•ì‹ì´ ì•„ë‹˜");
      parsedResponse = {
        result: 0,
        yoloBoxes: [],
        analysis: "",
        analysis_reason: "ë‘í”¼ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¡°ê¸ˆ ë” ê°€ê¹Œì´ ì°ì–´ì£¼ì‹œê±°ë‚˜ ë³´ë‹¤ ë°ì€ ê³³ì—ì„œ ì°ì–´ì£¼ì„¸ìš”.",
        recommendation: []
      };
    }

    res.json({ imageUrl, ...parsedResponse });
  } catch (err) {
    console.error("OpenAI API ì˜¤ë¥˜:", err);
    res.status(500).json({ error: "AI ë¶„ì„ ì‹¤íŒ¨" });
  }
});


// âœ… ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ì œê³µ (ì •ì  íŒŒì¼ ì„œë¹™)
app.use(`/${process.env.UPLOADS_DIR}`, express.static(uploadDir));

// âœ… ì„œë²„ ì‹¤í–‰
const PORT = process.env.PORT || 5000;
app.listen(PORT, () => console.log(`ðŸš€ ì„œë²„ ì‹¤í–‰ ì¤‘: http://localhost:${PORT}`));
